name: Develop CI - Quick Validation

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

env:
  NODE_VERSION: "20"

jobs:
  # =============================================================================
  # Quick Linting & Type Checking
  # =============================================================================
  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install workspace dependencies
        run: npm install

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm run install:force

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Run TypeScript type checking
        run: |
          cd frontend
          npm run check:ci

  # =============================================================================
  # Quick Build Validation
  # =============================================================================
  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: lint-and-type-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install workspace dependencies
        run: npm install

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm run install:force

      - name: Build frontend
        run: |
          cd frontend
          npm run build:ci

      - name: Verify build output
        run: |
          cd frontend
          ls -la build/
          test -f build/index.html

  # =============================================================================
  # Quick Docker Backend Test
  # =============================================================================
  backend-smoke-test:
    name: Backend Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start backend service
        run: |
          docker-compose -f compose/docker-compose.ci.yml up radio-backend -d
          sleep 15

      - name: Test backend health
        run: |
          for i in {1..10}; do
            if curl -f http://localhost:8000/health; then
              echo "Backend health check passed!"
              break
            else
              echo "Health check attempt $i/10 failed, retrying..."
              if [ $i -eq 10 ]; then
                echo "Backend health check failed after 10 attempts"
                exit 1
              fi
              sleep 5
            fi
          done

      - name: View backend logs
        if: failure()
        run: |
          docker-compose -f compose/docker-compose.ci.yml logs radio-backend

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f compose/docker-compose.ci.yml down -v

  # =============================================================================
  # Notify Success
  # =============================================================================
  success-notification:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, build-validation, backend-smoke-test]
    if: success()

    steps:
      - name: Success message
        run: |
          echo "ðŸŽ‰ Develop CI pipeline completed successfully!"
          echo "âœ… Linting passed"
          echo "âœ… Type checking passed"
          echo "âœ… Build validation passed"
          echo "âœ… Backend smoke test passed"
          echo ""
          echo "Ready for development! ðŸš€"
