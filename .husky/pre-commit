#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ” Running pre-commit checks on branch: $BRANCH"

# Always run lint-staged for basic linting and auto-fixes
echo "ğŸ“ Running lint-staged..."
npx --prefix app lint-staged

# Exit if lint-staged fails
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed. Please fix the issues above."
  exit 1
fi

# Branch-specific checks
if [ "$BRANCH" = "main" ]; then
  echo "ğŸ­ Main branch detected - running full validation..."

  # Full type checking for main branch
  echo "ğŸ” Running TypeScript type checking..."
  npm run type-check

  if [ $? -ne 0 ]; then
    echo "âŒ Type checking failed on main branch."
    exit 1
  fi

  # Could add more checks here like:
  # - Unit tests
  # - Build validation
  echo "âœ… Full validation complete for main branch"

elif [ "$BRANCH" = "develop" ]; then
  echo "ğŸš€ Develop branch detected - running quick checks..."

  # Quick type check (could be made faster if needed)
  echo "âš¡ Running quick TypeScript validation..."
  npm run type-check

  if [ $? -ne 0 ]; then
    echo "âš ï¸  Type checking failed on develop branch."
    echo "ğŸ’¡ Consider fixing before pushing, but allowing commit to proceed..."
    # Don't exit - allow commit but warn
  fi

  echo "âœ… Quick validation complete for develop branch"

else
  echo "ğŸŒ¿ Feature branch detected - running minimal checks..."
  echo "ğŸ’¡ Only linting was performed. Consider switching to develop for more validation."
fi

echo "ğŸ‰ Pre-commit checks completed successfully!"
