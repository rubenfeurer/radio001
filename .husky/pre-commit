#!/usr/bin/env sh

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ” Running pre-commit checks on branch: $BRANCH"

# Check if we're in the new frontend structure
if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
  echo "ğŸ“ Running frontend lint checks..."
  cd frontend

  # Run ESLint with auto-fix
  npm run lint:fix
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend linting failed. Please fix the issues above."
    exit 1
  fi

  # Run TypeScript checking
  echo "ğŸ” Running TypeScript type checking..."
  npm run check
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript checking failed. Please fix the issues above."
    exit 1
  fi

  cd ..
  echo "âœ… Frontend checks passed"
fi

# Check backend if it exists
if [ -d "backend" ] && [ -f "backend/requirements.txt" ]; then
  echo "ğŸ Checking backend formatting..."
  if command -v black >/dev/null 2>&1; then
    black backend/ --check
    if [ $? -ne 0 ]; then
      echo "âŒ Backend code formatting failed. Run 'black backend/' to fix."
      exit 1
    fi
  else
    echo "âš ï¸  Black not installed, skipping backend formatting check"
  fi
  echo "âœ… Backend checks passed"
fi

# Branch-specific checks
if [ "$BRANCH" = "main" ]; then
  echo "ğŸ­ Main branch detected - running additional validation..."

  # Test build for main branch
  if [ -d "frontend" ]; then
    echo "ğŸ”¨ Testing production build..."
    cd frontend
    npm run build
    if [ $? -ne 0 ]; then
      echo "âŒ Production build failed on main branch."
      exit 1
    fi
    cd ..
  fi

  echo "âœ… Full validation complete for main branch"

elif [ "$BRANCH" = "develop" ]; then
  echo "ğŸš€ Develop branch detected - running standard checks..."
  echo "âœ… Standard validation complete for develop branch"

else
  echo "ğŸŒ¿ Feature branch detected - basic checks completed"
  echo "ğŸ’¡ Switch to develop branch for more comprehensive validation"
fi

echo "ğŸ‰ Pre-commit checks completed successfully!"
