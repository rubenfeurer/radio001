# Development Docker Compose configuration
# For local development with hot reload and easy debugging

services:
  # Backend API service
  radio-backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: radio-backend-dev
    hostname: radio-backend
    network_mode: host
    volumes:
      # Source code mounting for hot reload
      - ../backend:/app:cached
      # Configuration file
      - ../config/radio.conf:/app/config/radio.conf:ro
      # Data directory for station storage (mounts to /app/data since workdir is /app)
      - ../data:/app/data:rw
      # Assets directory for sounds
      - ../assets:/app/assets:ro
      # Python cache
      - radio_python_cache:/root/.cache/pip

      # System integration for WiFi management (NetworkManager)
      - /etc/NetworkManager:/etc/NetworkManager:rw
      - /var/lib/NetworkManager:/var/lib/NetworkManager:rw
      - /run/NetworkManager:/run/NetworkManager:rw
      - /run/dbus:/run/dbus:rw
      - /var/run/dbus:/var/run/dbus:rw
      - /etc/hostapd:/etc/hostapd:rw
      - /etc/raspiwifi:/etc/raspiwifi:rw

      # PolicyKit configuration for NetworkManager authorization
      - ../config/polkit:/etc/polkit-1/localauthority/50-local.d:ro

      # Device access for WiFi management
      - /dev:/dev:rw
      - /sys/class/net:/sys/class/net:ro
    env_file:
      - ../config/radio.conf
    environment:
      # Config file location
      - CONFIG_FILE=/app/config/radio.conf

      # Application settings (can be overridden by config file)
      - NODE_ENV=production
      - HOSTNAME=radio

      # Development flags
      - DEBUG=1
    restart: unless-stopped
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun
    depends_on: []
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Note: Frontend now runs locally with 'npm run dev:frontend'
  # Use 'docker-compose -f docker-compose.prod.yml up' for production deployment

  # Optional: Traefik for local .local domain routing
  traefik:
    image: traefik:v3.0
    container_name: radio-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    profiles:
      - traefik
    restart: unless-stopped

  # Optional: Avahi for mDNS (only on Linux hosts)
  avahi:
    image: solidnerd/avahi:latest
    container_name: radio-avahi
    hostname: radio
    network_mode: host
    environment:
      - AVAHI_HOST_NAME=radio
      - AVAHI_SERVICES=http:8000:path=/api
    volumes:
      - ../config/avahi:/etc/avahi:ro
    profiles:
      - mdns
    restart: unless-stopped
    depends_on:
      - radio-backend

# Named volumes for development
volumes:
  radio_python_cache:
    driver: local
